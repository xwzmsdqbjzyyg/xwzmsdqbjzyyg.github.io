<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 支付宝接口开发（即时到账） · 一天进步一点</title><meta name="description" content="支付宝接口开发（即时到账） - 陈长生"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/1977719157" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/xwzmsdqbjzyyg/xwzmsdqbjzyyg.github.io" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">支付宝接口开发（即时到账）</h1><div class="post-info">2016年8月4日</div><div class="post-content"><p>准备企业PID，Key，企业支付宝账号   （注意，PID只要登录就能获取，但是Key需要支付宝的【支付密码】验证后才能获取。） demo下载：<a href="https://b.alipay.com/order/techService.htm。" target="_blank" rel="external">https://b.alipay.com/order/techService.htm。</a><br>代码文件结构 ，使用注意部分  参阅 readme.txt</p>
<pre><code>create_direct_pay_by_user-php-UTF-8
</code></pre><p>  │<br>  ├lib┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈类文件夹<br>  │  │<br>  │  ├alipay_core.function.php ┈┈┈┈┈┈支付宝接口公用函数文件<br>  │  │<br>  │  ├alipay_notify.class.php┈┈┈┈┈┈┈支付宝通知处理类文件<br>  │  │<br>  │  ├alipay_submit.class.php┈┈┈┈┈┈┈支付宝各接口请求提交类文件<br>  │  │<br>  │  └alipay_md5.function.php┈┈┈┈┈┈┈支付宝接口MD5函数文件<br>  │<br>  ├log.txt┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈日志文件<br>  │<br>  ├alipay.config.php┈┈┈┈┈┈┈┈┈┈┈┈基础配置类文件<br>  │<br>  ├alipayapi.php┈┈┈┈┈┈┈┈┈┈┈┈┈┈支付宝接口入口文件<br>  │<br>  ├notify_url.php ┈┈┈┈┈┈┈┈┈┈┈┈┈服务器异步通知页面文件<br>  │<br>  ├return_url.php ┈┈┈┈┈┈┈┈┈┈┈┈┈页面跳转同步通知文件<br>  │<br>  ├cacert.pem ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈用于CURL中校验SSL的CA证书文件<br>  │<br>  └readme.txt ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈使用说明文本</p>
<ol>
<li><p>结构分为两部分：接入部分与通知 返回 部分。接入部分即为传递参数等信息组合成超级链接，并用该链接来进行跳转。通知返回部分则是支付宝服务器对该笔订单处理完毕后，通知与返回该笔订单的详细信息到商户服务器，商<br>户服务器接收到后，并对其进行数据处理。</p>
</li>
<li><p>接入部分：</p>
<p> 选定参数信息<br> 排序<br> 加密<br> 拼接字符串成URL链接<br> 自动跳转</p>
</li>
</ol>
<p>在 alipay.config.php中对需要配置的参数信息已经有详细说明， 具体在项目中一般会在config.php中配置好，将lib下的类文件（可以重命名）以及cacert.pem 放置在项目的合适位置，确保能够正确引入。</p>
<p>   构造 alipayapi.php中$parameter需要的参数 </p>
<p>   /<strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong>请求参数<strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong>/<br>        //商户订单号，商户网站订单系统中唯一订单号，必填<br>        $out_trade_no = $_POST[‘WIDout_trade_no’];<br>        //订单名称，必填<br>        $subject = $_POST[‘WIDsubject’];<br>        //付款金额，必填<br>        $total_fee = $_POST[‘WIDtotal_fee’];<br>        //商品描述，可空<br>        $body = $_POST[‘WIDbody’];<br>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/<br>//构造要请求的参数数组，无需改动<br>$parameter = array(<br>        “service”       =&gt; $alipay_config[‘service’],<br>        “partner”       =&gt; $alipay_config[‘partner’],<br>        “seller_id”  =&gt; $alipay_config[‘seller_id’],<br>        “payment_type”    =&gt; $alipay_config[‘payment_type’],<br>        “notify_url”    =&gt; $alipay_config[‘notify_url’],<br>        “return_url”    =&gt; $alipay_config[‘return_url’],</p>
<pre><code>&quot;anti_phishing_key&quot;=&gt;$alipay_config[&apos;anti_phishing_key&apos;],
&quot;exter_invoke_ip&quot;=&gt;$alipay_config[&apos;exter_invoke_ip&apos;],
&quot;out_trade_no&quot;    =&gt; $out_trade_no,
&quot;subject&quot;    =&gt; $subject,
&quot;total_fee&quot;    =&gt; $total_fee,
&quot;body&quot;    =&gt; $body,
&quot;_input_charset&quot;    =&gt; trim(strtolower($alipay_config[&apos;input_charset&apos;]))
//其他业务参数根据在线开发文档，添加参数.文档地址:https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.kiX33I&amp;treeId=62&amp;articleId=103740&amp;docType=1
//如&quot;参数名&quot;=&gt;&quot;参数值&quot;
</code></pre><p>);<br>//建立请求<br>$alipaySubmit = new AlipaySubmit($alipay_config);<br>$html_text = $alipaySubmit-&gt;buildRequestForm($parameter,”get”, “确认”);<br>echo $html_text;<br>die;</p>
<p>  需要注意的是开发支付接口需要在公网（服务器必须可以通过外网访问）才可以完成整个调试过程，如果服务器在外网访问不到，则无法接收到支付通知。</p>
<p>   $notify_url和$return_url 需<a href="http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问" target="_blank" rel="external">http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</a> 。</p>
<ol>
<li><p>通知 返回 （具体业务逻辑在通知返回页面处理）</p>
<p>参考：<a href="http://www.cnblogs.com/blodfox777/archive/2009/11/03/1595223.html" target="_blank" rel="external">http://www.cnblogs.com/blodfox777/archive/2009/11/03/1595223.html</a></p>
</li>
</ol>
<p>a) 返回页<br>传递给支付宝时的return_url参数所对应的页面文件。<br>具备的属性：<br>1、支付接口中买家的购买流程已经走到支付宝里且支付宝提示支付成功时，页面会自动跳转回自身网站的这个页面里来。<br>2、同步的，无时差<br>3、获得参数的方法是用get方式获取。<br>4、不论跳转回来程序判断是真还是假（$_GET[‘trade_status’] == ‘TRADE_FINISHED’ || $_GET[‘trade_status’] == ‘TRADE_SUCCESS’）只跳转回来一次，不重复。<br>5、这个并不是支付宝服务器调用了该页面，而是通过与组合拼接各参数形成的URL链接原理等同，拼接出来的URL链接，之后程序上做自动跳转。<br>6、基于5的原因，该页面的程序调试可不必在服务器上而是本机上调试、运行。<br>b) 通知页<br>传递给支付宝时的notify_url参数所对应的页面文件<br>具备的属性：<br>1、这个通知页就是被支付宝调用才能启动的。<br>2、服务器间的互动，不像返回页肉眼可以看到，这个是看不到的。<br>3、获得参数的方法是用POST方式获取。<br>4、支付宝中的该笔交易存在，且该笔交易状态发生了变更，就会被调用。<br>5、被调用程序判断（if(sign = mysign and responseTxt = true)），若我们自己在该判断中有做程序编写，成功则不再被调用，不成功则会反复被调用。<br>6、异步的，第一次收到订单信息（以下都称之为“通知”）是与返回页近乎等同或等同的同步时间，在判断不成功的情况下，会收到第二次第三次等次数的通知，时间间隔从最先的一两分钟，到后面的几个小时。失效时间是4<br>8小时。<br>7、基于6的原因，该页面的程序调试必须在服务器上调试、运行。<br>8、程序编写时必须采用程序执行成功，才写页面response.Write(“success”);，不成功则写页面response.Write(“fail”); 支付宝根据success来判定是否要重新再次发送通知。<br>9、该页面的Html页面中必须是空白、无任何Html标签、无任何空格。</p>
<p>c) 在支付宝的众多接口中，不是所有的接口都拥有通知页与返回页的。<br>有的接口只有返回页；有的接口有通知页且用XML格式的内容显示在当前页面中；有的没有通知页也没有返回页仅仅只以XML格式的内容显示在当前页面中。所以，我们要根据各接口的技术文档与程序实例来做相应的数据处<br>理。<br>d) 大家这里存在一个疑问，一般大家的做法都是把数据库更新些在返回页中，但是很多情况下出现了订单不同步即掉单现象。这是为什么？<br>答：返回页是当前页面自动跳转的，这虽然跳转的反应速度不错，但人的手动关闭该页面操作绝对可以使之在没有跳转回来之前就关掉了该页面，此时原本该数据库更新的程序并没有被启动，这样直接导致了掉单，所以一般大商<br>户，尤其是网络游戏行业的即时到帐充值的技术做法是：返回页中有订单处理程序，通知页中也有，当返回页中的订单没做过处理时，通知页中的数据处理程序便启动；这样即可近乎100%解决掉单问题（还有种掉单原因是大家自己的服务器出现问题，比如MS3XML.DLL问题，这个问题至今没有什么可以解决的办法，只能重装或是更换服务器，也有的服务器因为中毒才导致的）。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/12/phpmailer/" class="prev">PREV</a><a href="/2016/06/24/fopen-01/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://xwzmsdqbjzyyg.github.io">陈长生</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>